- name: Build and AI Auto-Fix Loop
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd esp-idf
          source export.sh
          cd ../micropython/ports/esp32
          
          ATTEMPT=1
          SUCCESS=false

          while [ "$SUCCESS" = false ]; do
            echo "=========================================="
            echo "üîÑ DENEME NO: $ATTEMPT"
            echo "=========================================="
            
            # Derlemeyi ba≈ülat
            make BOARD=ESP32_GENERIC_S3 BOARD_VARIANT=SPIRAM_OCT \
                 USER_C_MODULES=${{ github.workspace }}/main_repo/micropython.cmake \
                 ESP_IDF_PATH=${{ github.workspace }}/esp-idf > build_log.txt 2>&1
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ BA≈ûARILI: Firmware olu≈üturuldu!"
              SUCCESS=true
            else
              if [ $((ATTEMPT % 5)) -eq 0 ]; then
                echo "‚è≥ KOTA Lƒ∞Mƒ∞Tƒ∞: 10 dakika mola veriliyor..."
                sleep 600
              fi

              echo "‚ùå HATA SAPTANDI. Gemini s√ºreci analiz ediyor..."
              
              python3 - <<EOF
import os
from google import genai
client = genai.Client(api_key=os.environ.get("GEMINI_API_KEY"))
try:
    with open("build_log.txt", "r") as f:
        log = f.read()[-4000:]
    
    # AI'ya hem analizi hem komutlarƒ± istiyoruz
    prompt = f"MicroPython ESP32 build error (Attempt $ATTEMPT):\\n{log}\\n\\nTask: Explain the error briefly and provide the fix in a bash block. You are in micropython/ports/esp32."
    
    response = client.models.generate_content(model="gemini-3-flash-preview", contents=prompt)
    
    full_text = response.text
    print("\nü§ñ GEMINI ANALƒ∞Zƒ∞ VE √ñNERƒ∞Sƒ∞:\n")
    print(full_text) # T√ºm d√º≈ü√ºnce s√ºrecini terminale basar
    print("\n------------------------------------------")

    # Bash bloklarƒ±nƒ± ayƒ±kla ve fix.sh dosyasƒ±na yaz
    if "\`\`\`bash" in full_text:
        code = full_text.split("\`\`\`bash")[1].split("\`\`\`")[0]
        with open("fix.sh", "w") as f:
            f.write(code.strip())
    else:
        print("‚ö†Ô∏è Uyarƒ±: Gemini bash bloƒüu √ºretmedi, sadece a√ßƒ±klama yaptƒ±.")
except Exception as e:
    print(f"‚ùå SDK/API Hatasƒ±: {e}")
EOF

              if [ -f fix.sh ]; then
                echo "üõ†Ô∏è AI KOMUTLARI UYGULANIYOR..."
                chmod +x fix.sh
                ./fix.sh || true
                rm fix.sh
              fi
              ATTEMPT=$((ATTEMPT + 1))
            fi
            
            if [ $ATTEMPT -gt 50 ]; then
               echo "üõë KRƒ∞Tƒ∞K: 50 denemede √ß√∂z√ºm bulunamadƒ±."
               exit 1
            fi
          done
