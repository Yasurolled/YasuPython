- name: Build and AI Auto-Fix Loop
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd esp-idf
          source export.sh
          cd ../micropython/ports/esp32
          
          python3 -m pip install -q -U google-genai

          # En temiz Python scripti olu≈üturma y√∂ntemi
          cat << 'EOF' > ai_analyzer.py
import os
from google import genai
try:
    client = genai.Client(api_key=os.environ.get("GEMINI_API_KEY"))
    if not os.path.exists("build_log.txt"):
        print("Log file not found")
        sys.exit(0)
    with open("build_log.txt", "r") as f:
        log_data = f.read()[-4000:]
    
    prompt = f"MicroPython ESP32 build error:\n{log_data}\n\nTask: Explain the error briefly and provide the fix in a bash block. You are in micropython/ports/esp32."
    response = client.models.generate_content(model="gemini-3-flash-preview", contents=prompt)
    
    print("\nü§ñ GEMINI ANALIZI:\n", response.text)
    if "```bash" in response.text:
        code = response.text.split("```bash")[1].split("```")[0]
        with open("fix.sh", "w") as f:
            f.write(code.strip())
except Exception as e:
    print(f"Error: {e}")
EOF

          ATTEMPT=1
          MAX_ATTEMPTS=50
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "--- DENEME: $ATTEMPT ---"
            
            # Derleme komutu
            make BOARD=ESP32_GENERIC_S3 BOARD_VARIANT=SPIRAM_OCT \
                 USER_C_MODULES=${{ github.workspace }}/main_repo/micropython.cmake \
                 ESP_IDF_PATH=${{ github.workspace }}/esp-idf > build_log.txt 2>&1
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ SUCCESS!"
              exit 0
            fi

            # Hata varsa Gemini'yi √ßalƒ±≈ütƒ±r
            python3 ai_analyzer.py

            if [ -f fix.sh ]; then
              echo "üõ†Ô∏è Uygulanan Fix:"
              cat fix.sh
              chmod +x fix.sh
              ./fix.sh || true
              rm fix.sh
            fi

            # Kota Kontrol√º
            if [ $((ATTEMPT % 5)) -eq 0 ]; then
              echo "‚è≥ Kota bekletmesi (10dk)..."
              sleep 600
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done
