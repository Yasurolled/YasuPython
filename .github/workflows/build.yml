name: Build YasuPython AI-Fix

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: main_repo

      - name: Checkout MicroPython
        uses: actions/checkout@v4
        with:
          repository: micropython/micropython
          path: micropython
          submodules: recursive

      - name: Setup ESP-IDF
        run: |
          git clone --recursive --branch v5.2.2 https://github.com/espressif/esp-idf.git esp-idf
          cd esp-idf
          ./install.sh esp32s3

      - name: Build and AI Auto-Fix Loop
        shell: bash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd esp-idf
          source export.sh
          cd ../micropython/ports/esp32
          
          # SDK k√ºt√ºphanesini kur
          python3 -m pip install -q -U google-genai

          # Python scriptini temiz bir ≈üekilde olu≈ütur
          cat << 'EOF' > ai_analyzer.py
import os, sys
from google import genai
try:
    client = genai.Client(api_key=os.environ.get("GEMINI_API_KEY"))
    if not os.path.exists("build_log.txt"):
        print("Log dosyasƒ± hen√ºz olu≈ümadƒ±.")
        sys.exit(0)
    with open("build_log.txt", "r") as f:
        log_data = f.read()[-4000:]
    
    prompt = f"MicroPython ESP32 build error:\n{log_data}\n\nTask: Explain the error briefly and provide the fix in a bash block. You are in micropython/ports/esp32."
    response = client.models.generate_content(model="gemini-3-flash-preview", contents=prompt)
    
    print("\nü§ñ GEMINI ANALƒ∞Zƒ∞:\n", response.text)
    if "```bash" in response.text:
        code = response.text.split("```bash")[1].split("```")[0]
        with open("fix.sh", "w") as f:
            f.write(code.strip())
except Exception as e:
    print(f"Hata olu≈ütu: {e}")
EOF

          ATTEMPT=1
          MAX_ATTEMPTS=50
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "=========================================="
            echo "üîÑ DENEME: $ATTEMPT"
            echo "=========================================="
            
            # Derlemeyi dene
            make BOARD=ESP32_GENERIC_S3 BOARD_VARIANT=SPIRAM_OCT \
                 USER_C_MODULES=${{ github.workspace }}/main_repo/micropython.cmake \
                 ESP_IDF_PATH=${{ github.workspace }}/esp-idf > build_log.txt 2>&1
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ BA≈ûARILI: Firmware hazƒ±r!"
              exit 0
            fi

            # Hata varsa Gemini'yi √ßalƒ±≈ütƒ±r
            python3 ai_analyzer.py

            if [ -f fix.sh ]; then
              echo "üõ†Ô∏è Gemini fix uyguluyor..."
              chmod +x fix.sh
              ./fix.sh || true
              rm fix.sh
            fi

            if [ $((ATTEMPT % 5)) -eq 0 ]; then
              echo "‚è≥ Kota doldu, 10 dakika bekleniyor..."
              sleep 600
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Upload Firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: YasuPython-S3-Firmware
          path: micropython/ports/esp32/build-ESP32_GENERIC_S3-SPIRAM_OCT/firmware.bin
