,name: Build YasuPython ESP32S3

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout My Module
        uses: actions/checkout@v4
        with:
          path: my_module

      - name: Checkout MicroPython
        uses: actions/checkout@v4
        with:
          repository: micropython/micropython
          path: micropython
          submodules: recursive

      - name: Setup ESP-IDF
        run: |
          # S3 ve SPIRAM için en stabil sürüm v5.2.2
          git clone --recursive --branch v5.2.2 https://github.com/espressif/esp-idf.git esp-idf
          cd esp-idf
          ./install.sh esp32s3
          
      - name: Build Firmware
        shell: bash
        run: |
          # 1. ESP-IDF Ortamını Yükle
          cd esp-idf
          source export.sh
          export ESP_IDF_PATH=${{ github.workspace }}/esp-idf
          
          # 2. MicroPython Cross-Compiler Hazırla
          cd ../micropython
          make -C mpy-cross
          
          # 3. ESP32 Portuna Git
          cd ports/esp32
          
          # [DÜZELTME] Eksik touch_sens kütüphanesini sahte olarak oluştur (v5.2.2 uyumu için)
          mkdir -p components/esp_driver_touch_sens
          echo 'idf_component_register()' > components/esp_driver_touch_sens/CMakeLists.txt
          
          # [DÜZELTME] Senin C kodundaki "objbytes.h" hatasını otomatik düzelt
          # Bu dosya yeni sürümlerde yok, silinmesi derlemeyi kurtarır
          find ${{ github.workspace }}/my_module -name "*.c" -exec sed -i 's/#include "py\/objbytes.h"/\/\/ #include "py\/objbytes.h"/g' {} +
          
          # [DÜZELTME] TinyUSB ve Lock dosyası çakışmalarını temizle
          rm -rf build-ESP32_GENERIC_S3-SPIRAM_OCT
          mkdir -p managed_components
          
          # 4. Asıl Derleme Komutu
          # Hata verirse terminale son 150 satırı basar (Hatanın tam yerini görmek için)
          make BOARD=ESP32_GENERIC_S3 BOARD_VARIANT=SPIRAM_OCT \
               USER_C_MODULES=${{ github.workspace }}/my_module/micropython.cmake \
               ESP_IDF_PATH=${{ github.workspace }}/esp-idf > build_log.txt 2>&1 || \
               (echo "!!! KRİTİK HATA: LOGLAR DÖKÜLÜYOR !!!" && tail -n 150 build_log.txt && exit 1)
               
      - name: Upload Firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: YasuPython-ESP32S3-Firmware
          path: micropython/ports/esp32/build-ESP32_GENERIC_S3-SPIRAM_OCT/firmware.bin
