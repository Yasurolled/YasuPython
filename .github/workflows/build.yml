name: Build MicroPython with ESP WiFi TX Module

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Yasu's Module
        uses: actions/checkout@v4
        with:
          path: my_module  # Senin repon 'my_module' klasörüne inecek

      - name: Checkout MicroPython
        uses: actions/checkout@v4
        with:
          repository: micropython/micropython
          path: micropython # Ana repo 'micropython' klasörüne inecek
          submodules: recursive

      - name: Install ESP-IDF
        run: |
          cd micropython/lib/esp-idf  # MicroPython içinde IDF genellikle lib altındadır veya submodule'dur
          # Eğer üstteki yol hata verirse 'cd micropython/esp-idf' denenebilir (repoya göre değişir)
          git checkout v5.2.2 
          git submodule update --init --recursive
          ./install.sh esp32s3
          
      - name: Build Firmware
        run: |
          # 1. Ortamı hazırla
          cd micropython/lib/esp-idf
          source export.sh
          
          # 2. Hatalı bileşeni temizle
          cd ../../ports/esp32
          sed -i 's/esp_driver_touch_sens//g' main/CMakeLists.txt
          
          # 3. Derle (Yollar artik tam path olarak veriliyor)
          make BOARD=ESP32_GENERIC_S3 BOARD_VARIANT=SPIRAM_OCT \
               USER_C_MODULES=${{ github.workspace }}/my_module/micropython.cmake
               
      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YasuPython-S3-Firmware
          path: micropython/ports/esp32/build-ESP32_GENERIC_S3-SPIRAM_OCT/firmware.bin
